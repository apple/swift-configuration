//===----------------------------------------------------------------------===//
//
// This source file is part of the SwiftConfiguration open source project
//
// SPDX-License-Identifier: Apache-2.0
//
//===----------------------------------------------------------------------===//

%{
  from gyb_utils import *
}%
${autogenerated_warning()}
import Testing
@testable import Configuration
import ConfigurationTestingInternal

struct ConfigReaderMethodTestsWatch4 {

    typealias Defaults = ConfigReaderTests.Defaults
    typealias TestHTTPHeaders = ConfigReaderTests.TestHTTPHeaders

    @available(Configuration 1.0, *)
    @Test func watch() async throws {
        let config = ConfigReaderTests.config

        // Optional - success
        _ = try await config.watchStringArray(
            forKey: "httpHeaders",
            as: TestHTTPHeaders.self
        ) { updates in
            for await value in updates {
                #expect(value == Defaults.httpHeaders)
                break
            }
        }

        // Optional - missing (nil)
        _ = try await config.watchStringArray(
            forKey: "absentHTTPHeaders",
            as: TestHTTPHeaders.self
        ) { updates in
            for await value in updates {
                #expect(value == nil)
                break
            }
        }

        // Optional - failing (provider failure â†’ nil)
        _ = try await config.watchStringArray(
            forKey: "failure",
            as: TestHTTPHeaders.self
        ) { updates in
            for await value in updates {
                #expect(value == nil)
                break
            }
        }

        // Defaulted - success
        _ = try await config.watchStringArray(
            forKey: "httpHeaders",
            as: TestHTTPHeaders.self,
            default: Defaults.otherHTTPHeaders
        ) { updates in
            for await value in updates {
                #expect(value == Defaults.httpHeaders)
                break
            }
        }

        // Defaulted - missing (uses default)
        _ = try await config.watchStringArray(
            forKey: "absentHTTPHeaders",
            as: TestHTTPHeaders.self,
            default: Defaults.otherHTTPHeaders
        ) { updates in
            for await value in updates {
                #expect(value == Defaults.otherHTTPHeaders)
                break
            }
        }

        // Defaulted - failing (uses default)
        _ = try await config.watchStringArray(
            forKey: "failure",
            as: TestHTTPHeaders.self,
            default: Defaults.otherHTTPHeaders
        ) { updates in
            for await value in updates {
                #expect(value == Defaults.otherHTTPHeaders)
                break
            }
        }

        // Required - success
        _ = try await config.watchRequiredStringArray(
            forKey: "httpHeaders",
            as: TestHTTPHeaders.self
        ) { updates in
            for try await value in updates {
                #expect(value == Defaults.httpHeaders)
                break
            }
        }

        // Required - missing (throws ConfigError during iteration)
        _ = try await config.watchRequiredStringArray(
            forKey: "absentHTTPHeaders",
            as: TestHTTPHeaders.self
        ) { updates in
            await #expect(throws: ConfigError.self) {
                var iterator = updates.makeAsyncIterator()
                _ = try await iterator.next()
            }
        }

        // Required - failing (throws provider error during iteration)
        _ = try await config.watchRequiredStringArray(
            forKey: "failure",
            as: TestHTTPHeaders.self
        ) { updates in
            await #expect(throws: TestProvider.TestError.self) {
                var iterator = updates.makeAsyncIterator()
                _ = try await iterator.next()
            }
        }
    }
}

