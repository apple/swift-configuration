//===----------------------------------------------------------------------===//
//
// This source file is part of the SwiftConfiguration open source project
//
// SPDX-License-Identifier: Apache-2.0
//
//===----------------------------------------------------------------------===//

%{
  from gyb_utils import *
}%
${autogenerated_warning()}
import Testing
@testable import Configuration
import ConfigurationTestingInternal

struct ConfigReaderMethodTestsGet4 {

    typealias Defaults = ConfigReaderTests.Defaults
    typealias TestHTTPHeaders = ConfigReaderTests.TestHTTPHeaders

    @available(Configuration 1.0, *)
    @Test func get() throws {
        let config = ConfigReaderTests.config

        do {
            // --------------------------------------------------
            // Optional
            // --------------------------------------------------

            // Optional - success
            #expect(
                config.stringArray(
                    forKey: "httpHeaders",
                    as: TestHTTPHeaders.self
                ) == Defaults.httpHeaders
            )

            // Optional - missing
            #expect(
                config.stringArray(
                    forKey: "absentHTTPHeaders",
                    as: TestHTTPHeaders.self
                ) == nil
            )

            // Optional - failing (returns nil, does NOT throw)
            #expect(
                config.stringArray(
                    forKey: "failure",
                    as: TestHTTPHeaders.self
                ) == nil
            )

            // --------------------------------------------------
            // Defaulted
            // --------------------------------------------------

            // Defaulted - success
            #expect(
                config.stringArray(
                    forKey: "httpHeaders",
                    as: TestHTTPHeaders.self,
                    default: Defaults.otherHTTPHeaders
                ) == Defaults.httpHeaders
            )

            // Defaulted - missing
            #expect(
                config.stringArray(
                    forKey: "absentHTTPHeaders",
                    as: TestHTTPHeaders.self,
                    default: Defaults.otherHTTPHeaders
                ) == Defaults.otherHTTPHeaders
            )

            // Defaulted - failing (returns default, does NOT throw)
            #expect(
                config.stringArray(
                    forKey: "failure",
                    as: TestHTTPHeaders.self,
                    default: Defaults.otherHTTPHeaders
                ) == Defaults.otherHTTPHeaders
            )

            // --------------------------------------------------
            // Required
            // --------------------------------------------------

            // Required - success
            #expect(
                try config.requiredStringArray(
                    forKey: "httpHeaders",
                    as: TestHTTPHeaders.self
                ) == Defaults.httpHeaders
            )

            // Required - missing (throws ConfigError)
            let error1 = #expect(throws: ConfigError.self) {
                try config.requiredStringArray(
                    forKey: "absentHTTPHeaders",
                    as: TestHTTPHeaders.self
                )
            }
            #expect(
                error1 == .missingRequiredConfigValue(
                    AbsoluteConfigKey(["absentHTTPHeaders"])
                )
            )

            // Required - failing (throws provider error)
            #expect(throws: TestProvider.TestError.self) {
                try config.requiredStringArray(
                    forKey: "failure",
                    as: TestHTTPHeaders.self
                )
            }
        }
    }
}

