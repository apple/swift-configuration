//===----------------------------------------------------------------------===//
//
// This source file is part of the SwiftConfiguration open source project
//
// Copyright (c) 2025 Apple Inc. and the SwiftConfiguration project authors
// Licensed under Apache License v2.0
//
// See LICENSE.txt for license information
// See CONTRIBUTORS.txt for the list of SwiftConfiguration project authors
//
// SPDX-License-Identifier: Apache-2.0
//
//===----------------------------------------------------------------------===//

// License header will go here
%{
  from gyb_utils import *
}%
${autogenerated_warning()}
import Testing
@testable import Configuration
import ConfigurationTestingInternal

struct ConfigReaderMethodTestsWatch2 {
    
    typealias Defaults = ConfigReaderTests.Defaults
    typealias TestEnum = ConfigReaderTests.TestEnum
    typealias TestStringConvertible = ConfigReaderTests.TestStringConvertible

    @available(Configuration 1.0, *)
    @Test func watch() async throws {
        let config = ConfigReaderTests.config
        
        % for string_convertible_type in string_convertible_types:
        % suffix = "String"
        % test_type = string_convertible_type["testType"]
        % test_suffix = string_convertible_type["testSuffix"]
        % lower_test_suffix = lower_first(test_suffix)
        do {
            // Optional - success
            #expect(try await config.watch${suffix}(forKey: ConfigKey(["${lower_test_suffix}"]), as: ${test_type}.self, updatesHandler: awaitFirst) == Defaults.${lower_test_suffix})
            #expect(try await config.watch${suffix}(forKey: "${lower_test_suffix}", as: ${test_type}.self, updatesHandler: awaitFirst) == Defaults.${lower_test_suffix})

            // Optional - missing
            #expect(try await config.watch${suffix}(forKey: ConfigKey(["absent${test_suffix}"]), as: ${test_type}.self, updatesHandler: awaitFirst) == .some(nil))
            #expect(try await config.watch${suffix}(forKey: "absent${test_suffix}", as: ${test_type}.self, updatesHandler: awaitFirst) == .some(nil))

            // Optional - failing
            #expect(try await config.watch${suffix}(forKey: ConfigKey(["failure"]), as: ${test_type}.self, updatesHandler: awaitFirst) == .some(nil))
            #expect(try await config.watch${suffix}(forKey: "failure", as: ${test_type}.self, updatesHandler: awaitFirst) == .some(nil))

            // Defaulted - success
            #expect(try await config.watch${suffix}(forKey: ConfigKey(["${lower_test_suffix}"]), as: ${test_type}.self, default: Defaults.other${test_suffix}, updatesHandler: awaitFirst) == Defaults.${lower_test_suffix})
            #expect(try await config.watch${suffix}(forKey: "${lower_test_suffix}", as: ${test_type}.self, default: Defaults.other${test_suffix}, updatesHandler: awaitFirst) == Defaults.${lower_test_suffix})

            // Defaulted - missing
            #expect(try await config.watch${suffix}(forKey: ConfigKey(["absent${test_suffix}"]), as: ${test_type}.self, default: Defaults.other${test_suffix}, updatesHandler: awaitFirst) == Defaults.other${test_suffix})
            #expect(try await config.watch${suffix}(forKey: "absent${test_suffix}", as: ${test_type}.self, default: Defaults.other${test_suffix}, updatesHandler: awaitFirst) == Defaults.other${test_suffix})

            // Defaulted - failing
            #expect(try await config.watch${suffix}(forKey: ConfigKey(["failure"]), as: ${test_type}.self, default: Defaults.other${test_suffix}, updatesHandler: awaitFirst) == Defaults.other${test_suffix})
            #expect(try await config.watch${suffix}(forKey: "failure", as: ${test_type}.self, default: Defaults.other${test_suffix}, updatesHandler: awaitFirst) == Defaults.other${test_suffix})

            // Required - success
            #expect(try await config.watchRequired${suffix}(forKey: ConfigKey(["${lower_test_suffix}"]), as: ${test_type}.self, updatesHandler: awaitFirst) == Defaults.${lower_test_suffix})
            #expect(try await config.watchRequired${suffix}(forKey: "${lower_test_suffix}", as: ${test_type}.self, updatesHandler: awaitFirst) == Defaults.${lower_test_suffix})

            // Required - missing
            let error1 = await #expect(throws: ConfigError.self) { try await config.watchRequired${suffix}(forKey: ConfigKey(["absent${test_suffix}"]), as: ${test_type}.self, updatesHandler: awaitFirst) }
            #expect(error1 == .missingRequiredConfigValue(AbsoluteConfigKey(["absent${test_suffix}"])))
            let error2 = await #expect(throws: ConfigError.self) { try await config.watchRequired${suffix}(forKey: "absent${test_suffix}", as: ${test_type}.self, updatesHandler: awaitFirst) }
            #expect(error2 == .missingRequiredConfigValue(AbsoluteConfigKey(["absent${test_suffix}"])))

            // Required - failing
            await #expect(throws: TestProvider.TestError.self) { try await config.watchRequired${suffix}(forKey: ConfigKey(["failure"]), as: ${test_type}.self, updatesHandler: awaitFirst) }
            await #expect(throws: TestProvider.TestError.self) { try await config.watchRequired${suffix}(forKey: "failure", as: ${test_type}.self, updatesHandler: awaitFirst) }
        }
        % end
    }
}
